version: 2.1

# Define the jobs we want to run for this project
jobs:
  build:
    docker:
      - image: cimg/rust:1.63.0
    steps:
{%- for command in job.steps %}
      - run:
          name: {{command.title}}
          command: {{command.command}}
{% endfor %}

      - checkout

      - restore_cache:
          key: cargo-{{ "{{ checksum \"Cargo.lock\" }}" }}

      - run: otel-cli exec --service cargo --name "cargo check" -- cargo check --workspace

      - run:
          name: install cargo-nextest
          command: curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin
      - run:
          name: install circleci-junit-fix
          command: curl -sSL https://github.com/conradludgate/circleci-junit-fix/releases/download/v0.2.0/circleci-junit-fix-v0.2.0-x86_64-unknown-linux-gnu.tar.gz | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin

      - run: otel-cli exec --service cargo --name "cargo nextest" -- cargo nextest run --workspace --profile ci
      - run: otel-cli exec --service cargo --name "cargo test" -- cargo test --workspace --doc
      - run: otel-cli exec --service cargo --name "cargo build" -- cargo build --workspace

      - run:
          name: fix junit XML
          command: cat target/nextest/ci/junit.xml | circleci-junit-fix > fixed-report.xml
      - store_test_results:
          path: fixed-report.xml

      - save_cache:
          key: cargo-{{"{{ checksum \"Cargo.lock\" }}"}}
          paths:
            - ~/.cargo
            - target
